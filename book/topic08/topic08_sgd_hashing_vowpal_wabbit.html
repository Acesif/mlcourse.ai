
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Topic 8. Vowpal Wabbit: Learning with Gigabytes of Data &#8212; mlcourse.ai</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet">
  <link href="../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://c6.patreon.com/becomePatronButton.bundle.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Videolecture 8. Vowpal Wabbit: Learning with Gigabytes of Data" href="videolecture08.html" />
    <link rel="prev" title="Topic 8. Vowpal Wabbit: Learning with Gigabytes of Data" href="topic08_intro.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
<script>
                        window.ga = window.ga || function () {
                            (ga.q = ga.q || []).push(arguments) };
                        ga.l = +new Date;
                        ga('create', 'UA-125504619-1', 'auto');
                        ga('set', 'anonymizeIp', true);
                        ga('send', 'pageview');
                    </script>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/mlcourse_ai_logo.jpg" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">mlcourse.ai</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../index.html">
   Intro
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Prerequisites
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../prereqs/python.html">
   Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../prereqs/math.html">
   Math
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../prereqs/software_devops.html">
   Software &amp; DevOps
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../prereqs/docker.html">
   Docker
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Topic 1
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../topic01/topic01_intro.html">
   Topic 1 Intro
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic01/topic01_pandas_data_analysis.html">
   Exploratory data analysis with Pandas
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic01/videolecture01.html">
   Videolecture 1
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic01/assignment01_pandas_uci_adult.html">
   Demo Assignment 1 Task
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic01/assignment01_pandas_uci_adult_solution.html">
   Demo Assignment 1 Solution
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic01/bonus_assignment01_pandas_olympics.html">
   Bonus Assignment 1
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Topic 2
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../topic02/topic02_intro.html">
   Topic 2 Intro
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic02/topic02_visual_data_analysis.html">
   Visual Data Analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic02/topic02_additional_seaborn_matplotlib_plotly.html">
   Seaborn, Matplotlib, Plotly
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic02/videolecture02.html">
   Videolecture 2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic02/assignment02_analyzing_cardiovascular_desease_data.html">
   Demo Assignment 2 Task
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic02/assignment02_analyzing_cardiovascular_desease_data_solution.html">
   Demo Assignment 2 Solution
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic02/bonus_assignment02_visual_analysis.html">
   Bonus Assignment 2
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Topic 3
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../topic03/topic03_intro.html">
   Topic 3 Intro
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic03/topic03_decision_trees_kNN.html">
   Classification, Decision Trees &amp; k Nearest Neighbors
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic03/videolecture03.html">
   Videolecture 3
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic03/assignment03_decision_trees.html">
   Demo Assignment 3 Task
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic03/assignment03_decision_trees_solution.html">
   Demo Assignment 3 Solution
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic03/bonus_assignment03_decision_trees.html">
   Bonus Assignment 3
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Topic 4
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../topic04/topic04_intro.html">
   Topic 4 Intro
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic04/topic4_linear_models_part1_mse_likelihood_bias_variance.html">
   Ordinary Least Squares
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic04/topic4_linear_models_part2_logit_likelihood_learning.html">
   Linear classification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic04/topic4_linear_models_part3_regul_example.html">
   An illustrative example of logistic regression regularization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic04/topic4_linear_models_part4_good_bad_logit_movie_reviews_XOR.html">
   When logistic regression is good and when it is not
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic04/topic4_linear_models_part5_valid_learning_curves.html">
   Validation and learning curves
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic04/videolecture04.html">
   Videolecture 4
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic04/assignment04_regression_wine.html">
   Demo Assignment 4 Task
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic04/assignment04_regression_wine_solution.html">
   Demo Assignment 4 Solution
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic04/bonus_assignment04_alice_baselines.html">
   Bonus Assignment 4
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Topic 5
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../topic05/topic05_intro.html">
   Topic 5 Intro
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic05/topic5_part1_bagging.html">
   Bagging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic05/topic5_part2_random_forest.html">
   Random Forest
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic05/topic5_part3_feature_importance.html">
   Feature importance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic05/videolecture05.html">
   Videolecture 5
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic05/assignment05_logit_rf_credit_scoring.html">
   Demo Assignment 5
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic05/assignment05_logit_rf_credit_scoring_solution.html">
   Demo Assignment 5 Solution
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic05/bonus_assignment05_logreg_rf.html">
   Bonus Assignment 5
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Topic 6
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../topic06/topic06_intro.html">
   Topic 6 Intro
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic06/topic6_feature_engineering_feature_selection.html">
   Feature engineering &amp; feature selection
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic06/demo_assignment06.html">
   Demo Assignment 6 Task
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic06/bonus_assignment06.html">
   Bonus Assignment 6
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Topic 7
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../topic07/topic07_intro.html">
   Topic 7 Intro
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic07/topic7_pca_clustering.html">
   Unsupervised learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic07/videolecture07.html">
   Videolecture 7
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic07/assignment07_unsupervised_learning.html">
   Demo Assignment 7
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic07/assignment07_unsupervised_learning_solution.html">
   Demo Assignment 7 Solution
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic07/bonus_assignment07.html">
   Bonus Assignment 7
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Topic 8
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="topic08_intro.html">
   Topic 8 Intro
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Vowpal Wabbit: Learning with Gigabytes of Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="videolecture08.html">
   Videolecture 8
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="assignment08_implement_sgd_regressor.html">
   Demo Assignment 8
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="assignment08_implement_sgd_regressor_solution.html">
   Demo Assignment 8 Solution
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="bonus_assignment08.html">
   Bonus Assignment 8
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Topic 9
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../topic09/topic09_intro.html">
   Topic 9 Intro
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic09/topic9_part1_time_series_python.html">
   Topic 9. Time series analysis in Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic09/topic9_part2_facebook_prophet.html">
   Predicting the future with Facebook Prophet
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic09/videolecture09.html">
   Videolecture 9
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic09/assignment09_time_series.html">
   Demo Assignment 9
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic09/assignment09_time_series_solution.html">
   Demo Assignment 9 Solution
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic09/bonus_assignment09.html">
   Bonus Assignment 9
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Topic 10
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../topic10/topic10_intro.html">
   Topic 10 Intro
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic10/topic10_gradient_boosting.html">
   Gradient boosting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic10/videolecture10.html">
   Videolecture 10
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic10/assignment10_flight_delays_kaggle.html">
   Demo Assignment 10
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../topic10/bonus_assignment10.html">
   Bonus Assignment 10
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  About the course
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../extra/tutorials.html">
   Tutorials
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../extra/rating.html">
   Rating
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../extra/resources.html">
   Resources
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../extra/contributors.html">
   Contributors
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        <a class="dropdown-buttons"
            href="../../_sources/book/topic08/topic08_sgd_hashing_vowpal_wabbit.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download notebook file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/book/topic08/topic08_sgd_hashing_vowpal_wabbit.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/Yorko/mlcourse.ai/"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/Yorko/mlcourse.ai//issues/new?title=Issue%20on%20page%20%2Fbook/topic08/topic08_sgd_hashing_vowpal_wabbit.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/Yorko/mlcourse.ai/edit/main/mlcourse_ai_jupyter_book/book/topic08/topic08_sgd_hashing_vowpal_wabbit.md"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/Yorko/mlcourse.ai/main?urlpath=tree/mlcourse_ai_jupyter_book/book/topic08/topic08_sgd_hashing_vowpal_wabbit.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#article-outline">
   Article outline
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#stochastic-gradient-descent-and-online-learning">
   1. Stochastic gradient descent and online learning
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#stochastic-gradient-descent">
     1.1. Stochastic gradient descent
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#online-approach-to-learning">
     1.2. Online approach to learning
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#categorical-feature-processing">
   2. Categorical feature processing
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#label-encoding">
     2.1. Label Encoding
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#one-hot-encoding">
     2.2. One-Hot Encoding
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#hashing-trick">
     2.3. Hashing trick
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#vowpal-wabbit">
   3. Vowpal Wabbit
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#news-binary-classification">
     3.1. News. Binary classification.
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#news-multiclass-classification">
     3.2. News. Multiclass classification
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#imdb-movie-reviews">
     3.3. IMDB movie reviews
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#classifying-gigabytes-of-stackoverflow-questions">
     3.4. Classifying gigabytes of StackOverflow questions
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#useful-resources">
   4. Useful resources
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="topic-8-vowpal-wabbit-learning-with-gigabytes-of-data">
<span id="topic08"></span><h1>Topic 8. Vowpal Wabbit: Learning with Gigabytes of Data<a class="headerlink" href="#topic-8-vowpal-wabbit-learning-with-gigabytes-of-data" title="Permalink to this headline">¶</a></h1>
<img src="https://habrastorage.org/webt/ia/m9/zk/iam9zkyzqebnf_okxipihkgjwnw.jpeg" />
<p><strong><center><a class="reference external" href="https://mlcourse.ai">mlcourse.ai</a> – Open Machine Learning Course</strong> </center><br></p>
<p>Author: <a class="reference external" href="https://yorko.github.io">Yury Kashnitsky</a>. Translated and edited by <a class="reference external" href="https://www.linkedin.com/in/sergeoreshkov/">Serge Oreshkov</a>, and <a class="reference external" href="https://www.linkedin.com/in/yuanyuanpao/">Yuanyuan Pao</a>. This material is subject to the terms and conditions of the <a class="reference external" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons CC BY-NC-SA 4.0</a> license. Free use is permitted for any non-commercial purpose.</p>
<p>This week, we’ll cover two reasons for Vowpal Wabbit’s exceptional training speed, namely, online learning and hashing trick, in both theory and practice. We will try it out with news, movie reviews, and StackOverflow questions.</p>
<div class="section" id="article-outline">
<h2>Article outline<a class="headerlink" href="#article-outline" title="Permalink to this headline">¶</a></h2>
<ol class="simple">
<li><p><a class="reference external" href="#stochastic-gradient-descent-and-online-learning">Stochastic gradient descent and online learning</a></p>
<ul class="simple">
<li><p>1.1. <a class="reference external" href="#stochastic-gradient-descent">SGD</a></p></li>
<li><p>1.2. <a class="reference external" href="#online-approach-to-learning">Online approach to learning</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#categorical-feature-processing">Categorical feature processing</a></p>
<ul class="simple">
<li><p>2.1. <a class="reference external" href="#label-encoding">Label Encoding</a></p></li>
<li><p>2.2. <a class="reference external" href="#one-hot-encoding">One-Hot Encoding</a></p></li>
<li><p>2.3. <a class="reference external" href="#hashing-trick">Hashing trick</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#vowpal-Wabbit">Vowpal Wabbit</a></p>
<ul class="simple">
<li><p>3.1. <a class="reference external" href="#news-binary-classification">News. Binary classification</a></p></li>
<li><p>3.2. <a class="reference external" href="#news-multiclass-classification">News. Multiclass classification</a></p></li>
<li><p>3.3. <a class="reference external" href="#imdb-movie-reviews">IMDB movie reviews</a></p></li>
<li><p>3.4. <a class="reference external" href="#classifying-gigabytes-of-stackoverflow-questionss">Classifying gigabytes of StackOverflow questions</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#useful-resources">Useful resources</a></p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">csr_matrix</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">fetch_20newsgroups</span><span class="p">,</span> <span class="n">load_files</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="p">(</span><span class="n">accuracy_score</span><span class="p">,</span> <span class="n">classification_report</span><span class="p">,</span>
                             <span class="n">confusion_matrix</span><span class="p">,</span> <span class="n">log_loss</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span>
                             <span class="n">roc_curve</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span><span class="p">,</span> <span class="n">OneHotEncoder</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="o">%</span><span class="n">config</span> <span class="n">InlineBackend</span><span class="o">.</span><span class="n">figure_format</span> <span class="o">=</span> <span class="s1">&#39;retina&#39;</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="stochastic-gradient-descent-and-online-learning">
<h2>1. Stochastic gradient descent and online learning<a class="headerlink" href="#stochastic-gradient-descent-and-online-learning" title="Permalink to this headline">¶</a></h2>
<div class="section" id="stochastic-gradient-descent">
<h3>1.1. Stochastic gradient descent<a class="headerlink" href="#stochastic-gradient-descent" title="Permalink to this headline">¶</a></h3>
<p>Despite the fact that gradient descent is one of the first things learned in machine learning and optimization courses, it is one of its modifications, Stochastic Gradient Descent (SGD), that is hard to top.</p>
<p>Recall that the idea of gradient descent is to minimize some function by making small steps in the direction of the fastest decrease. This method was named due to the following fact from calculus: vector <span class="math notranslate nohighlight">\(\nabla f = (\frac{\partial f}{\partial x_1}, \ldots \frac{\partial f}{\partial x_n})^\text{T}\)</span> of partial derivatives of the function <span class="math notranslate nohighlight">\(f(x) = f(x_1, \ldots x_n)\)</span> points to the direction of the fastest function growth. It means that, by moving in the opposite direction (antigradient), it is possible to decrease the function value with the fastest rate.</p>
<img src='https://habrastorage.org/files/4f2/75d/a46/4f275da467a44fc4a8d1a11007776ed2.jpg' width=50%>
<p>Here is a snowboarder (me) in Sheregesh, Russia’s most popular winter resort. (I highly recommended it if you like skiing or snowboarding). In addition to advertising the beautiful landscapes, this picture depicts the idea of gradient descent. If you want to ride as fast as possible, you need to choose the path of steepest descent. Calculating antigradients can be seen as evaluating the slope at various spots.</p>
<p><strong>Example</strong></p>
<p>The paired regression problem can be solved with gradient descent. Let us predict one variable using another: height with weight. Assume that these variables are linearly dependent. We will use the <a class="reference external" href="http://wiki.stat.ucla.edu/socr/index.php/SOCR_Data">SOCR</a> dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># for Jupyter-book, we copy data from GitHub, locally, to save Internet traffic,</span>
<span class="c1"># you can specify the data/ folder from the root of your cloned</span>
<span class="c1"># https://github.com/Yorko/mlcourse.ai repo, to save Internet traffic</span>
<span class="n">DATA_PATH</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/Yorko/mlcourse.ai/master/data/&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PATH_TO_WRITE_DATA</span> <span class="o">=</span> <span class="s2">&quot;../../tmp/&quot;</span>
<span class="n">data_demo</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="s2">&quot;weights_heights.csv&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">data_demo</span><span class="p">[</span><span class="s2">&quot;Weight&quot;</span><span class="p">],</span> <span class="n">data_demo</span><span class="p">[</span><span class="s2">&quot;Height&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Weight in lb&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Height in inches&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>Here we have a vector <span class="math notranslate nohighlight">\(x\)</span> of dimension <span class="math notranslate nohighlight">\(\ell\)</span> (weight of every person i.e. training sample) and <span class="math notranslate nohighlight">\(y\)</span>, a vector containing the height of every person in the dataset.</p>
<p>The task is the following: find weights <span class="math notranslate nohighlight">\(w_0\)</span> and <span class="math notranslate nohighlight">\(w_1\)</span> such that predicting height as <span class="math notranslate nohighlight">\(y_i = w_0 + w_1 x_i\)</span> (where <span class="math notranslate nohighlight">\(y_i\)</span> is <span class="math notranslate nohighlight">\(i\)</span>-th height value, <span class="math notranslate nohighlight">\(x_i\)</span> is <span class="math notranslate nohighlight">\(i\)</span>-th weight value) minimizes the squared error (as well as mean squared error since <span class="math notranslate nohighlight">\(\frac{1}{\ell}\)</span> doesn’t make any difference ):</p>
<div class="math notranslate nohighlight">
\[
SE(w_0, w_1) = \frac{1}{2}\sum_{i=1}^\ell(y_i - (w_0 + w_1x_{i}))^2 \rightarrow min_{w_0,w_1}
\]</div>
<p>We will use gradient descent, utilizing the partial derivatives of <span class="math notranslate nohighlight">\(SE(w_0, w_1)\)</span> over weights <span class="math notranslate nohighlight">\(w_0\)</span> and <span class="math notranslate nohighlight">\(w_1\)</span>.
An iterative training procedure is then defined by simple update formulas (we change model weights in small steps, proportional to a small constant <span class="math notranslate nohighlight">\(\eta\)</span>, towards the antigradient of the function <span class="math notranslate nohighlight">\(SE(w_0, w_1)\)</span>):</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{array}{rcl} w_0^{(t+1)} = w_0^{(t)} -\eta \frac{\partial SE}{\partial w_0} |_{t} \\  w_1^{(t+1)} = w_1^{(t)} -\eta \frac{\partial SE}{\partial w_1} |_{t} \end{array}
\end{split}\]</div>
<p>Computing the partial derivatives, we get the following:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{array}{rcl} w_0^{(t+1)} = w_0^{(t)} + \eta \sum_{i=1}^{\ell}(y_i - w_0^{(t)} - w_1^{(t)}x_i) \\  w_1^{(t+1)} = w_1^{(t)} + \eta \sum_{i=1}^{\ell}(y_i - w_0^{(t)} - w_1^{(t)}x_i)x_i \end{array}
\end{split}\]</div>
<p>This math works quite well as long as the amount of data is not large (we will not discuss issues with local minima, saddle points, choosing the learning rate, moments and other stuff –- these topics are covered very thoroughly in <a class="reference external" href="http://www.deeplearningbook.org/contents/numerical.html">the Numeric Computation chapter</a> in “Deep Learning”).
There is an issue with batch gradient descent – the gradient evaluation requires the summation of a number of values for every object from the training set. In other words, the algorithm requires a lot of iterations, and every iteration recomputes weights with formula which contains a sum <span class="math notranslate nohighlight">\(\sum_{i=1}^\ell\)</span> over the whole training set. What happens when we have billions of training samples?</p>
<img src="https://habrastorage.org/webt/ow/ng/cs/owngcs-lzoguklv1pn9vz_r4ssm.jpeg" />
<p>Hence the motivation for stochastic gradient descent! Simply put, we throw away the summation sign and update the weights only over single training samples (or a small number of them). In our case, we have the following:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{array}{rcl} w_0^{(t+1)} = w_0^{(t)} + \eta (y_i - w_0^{(t)} - w_1^{(t)}x_i) \\  w_1^{(t+1)} = w_1^{(t)} + \eta (y_i - w_0^{(t)} - w_1^{(t)}x_i)x_i \end{array}
\end{split}\]</div>
<p>With this approach, there is no guarantee that we will move in best possible direction at every iteration. Therefore, we may need many more iterations, but we get much faster weight updates.</p>
<p>Andrew Ng has a good illustration of this in his <a class="reference external" href="https://www.coursera.org/learn/machine-learning">machine learning course</a>. Let’s take a look.</p>
<img src='https://habrastorage.org/files/f8d/90c/f83/f8d90cf83b044255bb07df3373f25fc7.png'>
<p>These are the contour plots for some function, and we want to find the global minimum of this function. The red curve shows weight changes (in this picture, <span class="math notranslate nohighlight">\(\theta_0\)</span> and <span class="math notranslate nohighlight">\(\theta_1\)</span> correspond to our <span class="math notranslate nohighlight">\(w_0\)</span> and <span class="math notranslate nohighlight">\(w_1\)</span>). According to the properties of a gradient, the direction of change at every point is orthogonal to contour plots. With stochastic gradient descent, weights are changing in a less predictable manner, and it even may seem that some steps are wrong by leading away from minima; however, both procedures converge to the same solution.</p>
</div>
<div class="section" id="online-approach-to-learning">
<h3>1.2. Online approach to learning<a class="headerlink" href="#online-approach-to-learning" title="Permalink to this headline">¶</a></h3>
<p>Stochastic gradient descent gives us practical guidance for training both classifiers and regressors with large amounts of data up to hundreds of GBs (depending on computational resources).</p>
<p>Considering the case of paired regression, we can store the training data set <span class="math notranslate nohighlight">\((X,y)\)</span> in HDD without loading it into RAM (where it simply won’t fit), read objects one by one, and update the weights of our model:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{array}{rcl} w_0^{(t+1)} = w_0^{(t)} + \eta (y_i - w_0^{(t)} - w_1^{(t)}x_i) \\  w_1^{(t+1)} = w_1^{(t)} + \eta (y_i - w_0^{(t)} - w_1^{(t)}x_i)x_i \end{array}
\end{split}\]</div>
<p>After working through the whole training dataset, our loss function (for example, quadratic squared root error in regression or logistic loss in classification) will decrease, but it usually takes dozens of passes over the training set to make the loss small enough.</p>
<p>This approach to learning is called <strong>online learning</strong>, and this name emerged even before machine learning MOOC-s turned mainstream.</p>
<p>We did not discuss many specifics about SGD here. If you want dive into theory, I highly recommend <a class="reference external" href="https://www.amazon.com/Convex-Optimization-Stephen-Boyd/dp/0521833787">“Convex Optimization” by Stephen Boyd</a>. Now, we will introduce the Vowpal Wabbit library, which is good for training simple models with huge data sets thanks to stochastic optimization and another trick, feature hashing.</p>
<p>In scikit-learn, classifiers and regressors trained with SGD are named  <code class="docutils literal notranslate"><span class="pre">SGDClassifier</span></code> and <code class="docutils literal notranslate"><span class="pre">SGDRegressor</span></code> in <code class="docutils literal notranslate"><span class="pre">sklearn.linear_model</span></code>. These are nice implementations of SGD, but we’ll focus on VW since it is more performant than sklearn’s SGD models in many aspects.</p>
</div>
</div>
<div class="section" id="categorical-feature-processing">
<h2>2. Categorical feature processing<a class="headerlink" href="#categorical-feature-processing" title="Permalink to this headline">¶</a></h2>
<div class="section" id="label-encoding">
<h3>2.1. Label Encoding<a class="headerlink" href="#label-encoding" title="Permalink to this headline">¶</a></h3>
<p>Many classification and regression algorithms operate in Euclidean or metric space, implying that data is represented with vectors of real numbers. However, in real data, we often have categorical features with discrete values such as yes/no or January/February/…/December. We will see how to process this kind of data, particularly with linear models, and how to deal with many categorical features even when they have many unique values.</p>
<p>Let’s explore the <a class="reference external" href="https://archive.ics.uci.edu/ml/datasets/bank+marketing">UCI bank marketing dataset</a> where most of  features are categorical.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="s2">&quot;bank_train.csv&quot;</span><span class="p">))</span>
<span class="n">labels</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="p">,</span> <span class="s2">&quot;bank_train_target.csv&quot;</span><span class="p">),</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We can see that most of features are not represented by numbers. This poses a problem because we cannot use most machine learning methods (at least those implemented in scikit-learn) out-of-the-box.</p>
<p>Let’s dive into the “education” feature.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;education&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">barh</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<p>The most straightforward solution is to map each value of this feature into a unique number. For example, we can map  <code class="docutils literal notranslate"><span class="pre">university.degree</span></code> to 0, <code class="docutils literal notranslate"><span class="pre">basic.9y</span></code> to 1, and so on. You can use <code class="docutils literal notranslate"><span class="pre">sklearn.preprocessing.LabelEncoder</span></code> to perform this mapping.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">label_encoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">fit</span></code> method of this class finds all unique values and builds the actual mapping between categories and numbers, and the <code class="docutils literal notranslate"><span class="pre">transform</span></code> method  converts the categories into numbers. After <code class="docutils literal notranslate"><span class="pre">fit</span></code> is executed, <code class="docutils literal notranslate"><span class="pre">label_encoder</span></code> will have the <code class="docutils literal notranslate"><span class="pre">classes_</span></code> attribute with all unique values of the feature. Let us count them to make sure the transformation was correct.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mapped_education</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;education&quot;</span><span class="p">]))</span>
<span class="n">mapped_education</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">barh</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">label_encoder</span><span class="o">.</span><span class="n">classes_</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;education&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_education</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s apply the transformation to other columns of type <code class="docutils literal notranslate"><span class="pre">object</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">categorical_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">dtypes</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">union</span><span class="p">([</span><span class="s2">&quot;education&quot;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">categorical_columns</span><span class="p">:</span>
    <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">label_encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The main issue with this approach is that we have now introduced some relative ordering where it might not exist.</p>
<p>For example, we implicitly introduced algebra over the values of the job feature where we can now substract the job of client #2 from the job of client #1 :</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">job</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">job</span>
</pre></div>
</div>
</div>
</div>
<p>Does this operation make any sense? Not really. Let’s try to train logistic regression with this feature transformation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">logistic_regression_accuracy_on</span><span class="p">(</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">dataframe</span>
    <span class="n">train_features</span><span class="p">,</span> <span class="n">test_features</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">,</span> <span class="n">test_labels</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
        <span class="n">features</span><span class="p">,</span> <span class="n">labels</span>
    <span class="p">)</span>

    <span class="n">logit</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">()</span>
    <span class="n">logit</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_features</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">classification_report</span><span class="p">(</span><span class="n">test_labels</span><span class="p">,</span> <span class="n">logit</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_features</span><span class="p">))</span>


<span class="nb">print</span><span class="p">(</span><span class="n">logistic_regression_accuracy_on</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">categorical_columns</span><span class="p">],</span> <span class="n">labels</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>We can see that logistic regression never predicts class 1. In order to use linear models with categorical features, we will use a different approach: One-Hot Encoding.</p>
</div>
<div class="section" id="one-hot-encoding">
<h3>2.2. One-Hot Encoding<a class="headerlink" href="#one-hot-encoding" title="Permalink to this headline">¶</a></h3>
<p>Suppose that some feature can have one of 10 unique values. One-hot encoding creates 10 new features corresponding to these unique values, all of them <em>except one</em> are zeros.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">one_hot_example</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span><span class="n">i</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)}])</span>
<span class="n">one_hot_example</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">one_hot_example</span>
</pre></div>
</div>
</div>
</div>
<p>This idea is implemented in the <code class="docutils literal notranslate"><span class="pre">OneHotEncoder</span></code> class from <code class="docutils literal notranslate"><span class="pre">sklearn.preprocessing</span></code>. By default <code class="docutils literal notranslate"><span class="pre">OneHotEncoder</span></code> transforms data into a sparse matrix to save memory space because most of the values are zeroes and because we do not want to take up more RAM. However, in this particular example, we do not encounter such problems, so we are going to use a “dense” matrix representation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">onehot_encoder</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">encoded_categorical_columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">onehot_encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">categorical_columns</span><span class="p">])</span>
<span class="p">)</span>
<span class="n">encoded_categorical_columns</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We have 53 columns that correspond to the number of unique values of categorical features in our data set. When transformed with One-Hot Encoding, this data can be used with linear models:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">logistic_regression_accuracy_on</span><span class="p">(</span><span class="n">encoded_categorical_columns</span><span class="p">,</span> <span class="n">labels</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="hashing-trick">
<h3>2.3. Hashing trick<a class="headerlink" href="#hashing-trick" title="Permalink to this headline">¶</a></h3>
<p>Real data can be volatile, meaning we cannot guarantee that new values of categorical features will not occur. This issue hampers using a trained model on new data. Besides that, <code class="docutils literal notranslate"><span class="pre">LabelEncoder</span></code> requires preliminary analysis of the whole dataset and storage of constructed mappings in memory, which makes it difficult to work with large datasets.</p>
<p>There is a simple approach to vectorization of categorical data based on hashing and is known as, not-so-surprisingly, the hashing trick.</p>
<p>Hash functions can help us find unique codes for different feature values, for example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;university.degree&quot;</span><span class="p">,</span> <span class="s2">&quot;high.school&quot;</span><span class="p">,</span> <span class="s2">&quot;illiterate&quot;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span> <span class="nb">hash</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>We will not use negative values or values of high magnitude, so we restrict the range of values for the hash function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">hash_space</span> <span class="o">=</span> <span class="mi">25</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;university.degree&quot;</span><span class="p">,</span> <span class="s2">&quot;high.school&quot;</span><span class="p">,</span> <span class="s2">&quot;illiterate&quot;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span> <span class="nb">hash</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">%</span> <span class="n">hash_space</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Imagine that our data set contains a single (i.e. not married) student, who received a call on Monday. His feature vectors will be created similarly as in the case of One-Hot Encoding but in the space with fixed range for all features:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">hashing_example</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([{</span><span class="n">i</span><span class="p">:</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hash_space</span><span class="p">)}])</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;job=student&quot;</span><span class="p">,</span> <span class="s2">&quot;marital=single&quot;</span><span class="p">,</span> <span class="s2">&quot;day_of_week=mon&quot;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span> <span class="nb">hash</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">%</span> <span class="n">hash_space</span><span class="p">)</span>
    <span class="n">hashing_example</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="nb">hash</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">%</span> <span class="n">hash_space</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">hashing_example</span>
</pre></div>
</div>
</div>
</div>
<p>We want to point out that we hash not only feature values but also pairs of <strong>feature name + feature value</strong>. It is important to do this so that we can distinguish the same values of different features.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="nb">hash</span><span class="p">(</span><span class="s2">&quot;no&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">hash</span><span class="p">(</span><span class="s2">&quot;no&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">hash</span><span class="p">(</span><span class="s2">&quot;housing=no&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">hash</span><span class="p">(</span><span class="s2">&quot;loan=no&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Is it possible to have a collision when using hash codes? Sure, it is possible, but it is a rare case with large enough hashing spaces. Even if collision occurs, regression or classification metrics will not suffer much. In this case, hash collisions work as a form of regularization.</p>
<img src="https://habrastorage.org/webt/4o/wx/59/4owx59vdvwc9mzrf81t2fa2rqrc.jpeg">
<p>You may be saying “WTF?”; hashing seems counterintuitive. This is true, but these heuristics sometimes are, in fact, the only plausible approach to work with categorical data (what else can you do if you have 30M features?). Moreover, this technique has proven to just work. As you work more with data, you may see this for yourself.</p>
<p>A good analysis of hash collisions, their dependency on feature space and hashing space dimensions and affecting classification/regression performance is done in <a class="reference external" href="https://booking.ai/dont-be-tricked-by-the-hashing-trick-192a6aae3087">this article</a> by <a class="reference external" href="http://Booking.com">Booking.com</a>.</p>
</div>
</div>
<div class="section" id="vowpal-wabbit">
<h2>3. Vowpal Wabbit<a class="headerlink" href="#vowpal-wabbit" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/JohnLangford/vowpal_wabbit">Vowpal Wabbit</a> (VW) is one of the most widespread machine learning libraries used in industry. It is prominent for its training speed and support of many training modes, especially for online learning with big and high-dimensional data. This is one of the major merits of the library. Also, with the hashing trick implemented, Vowpal Wabbit is a perfect choice for working with text data.</p>
<p>Shell is the main interface for VW.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!vw --help | head
</pre></div>
</div>
</div>
</div>
<p>Vowpal Wabbit reads data from files or from standard input stream (stdin) with the following format:</p>
<p><code class="docutils literal notranslate"><span class="pre">[Label]</span> <span class="pre">[Importance]</span> <span class="pre">[Tag]|Namespace</span> <span class="pre">Features</span> <span class="pre">|Namespace</span> <span class="pre">Features</span> <span class="pre">...</span> <span class="pre">|Namespace</span> <span class="pre">Features</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">Namespace=String[:Value]</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">Features=(String[:Value]</span> <span class="pre">)*</span></code></p>
<p>here [] denotes non-mandatory elements, and (…)* means multiple inputs allowed.</p>
<ul class="simple">
<li><p><strong>Label</strong> is a number. In the case of classification, it is usually 1 and -1; for regression, it is a real float value</p></li>
<li><p><strong>Importance</strong> is a number. It denotes the sample weight during training. Setting this helps when working with imbalanced data.</p></li>
<li><p><strong>Tag</strong> is a string without spaces. It is the “name” of the sample that VW saves upon prediction. In order to separate Tag from Importance, it is better to start Tag with the ‘ character.</p></li>
<li><p><strong>Namespace</strong> is for creating different feature spaces.</p></li>
<li><p><strong>Features</strong> are object features inside a given <strong>Namespace</strong>. Features have weight 1.0 by default, but it can be changed, for example feature:0.1.</p></li>
</ul>
<p>The following string matches the VW format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span> <span class="mf">1.0</span> <span class="o">|</span><span class="n">Subject</span> <span class="n">WHAT</span> <span class="n">car</span> <span class="ow">is</span> <span class="n">this</span> <span class="o">|</span><span class="n">Organization</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Maryland</span><span class="p">:</span><span class="mf">0.5</span> <span class="n">College</span> <span class="n">Park</span>
</pre></div>
</div>
<p>Let’s check the format by running VW with this training sample:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>! echo &#39;1 1.0 |Subject WHAT car is this |Organization University of Maryland:0.5 College Park&#39; | vw
</pre></div>
</div>
</div>
</div>
<p>VW is a wonderful tool for working with text data. We’ll illustrate it with the <a class="reference external" href="http://scikit-learn.org/stable/datasets/twenty_newsgroups.html">20newsgroups dataset</a>, which contains letters from 20 different newsletters.</p>
<div class="section" id="news-binary-classification">
<h3>3.1. News. Binary classification.<a class="headerlink" href="#news-binary-classification" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># load data with sklearn&#39;s function</span>
<span class="n">newsgroups</span> <span class="o">=</span> <span class="n">fetch_20newsgroups</span><span class="p">(</span><span class="n">data_home</span><span class="o">=</span><span class="n">PATH_TO_WRITE_DATA</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">newsgroups</span><span class="p">[</span><span class="s2">&quot;target_names&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Lets look at the first document in this collection:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">text</span> <span class="o">=</span> <span class="n">newsgroups</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">newsgroups</span><span class="p">[</span><span class="s2">&quot;target_names&quot;</span><span class="p">][</span><span class="n">newsgroups</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we convert the data into something Vowpal Wabbit can understand. We will throw away words shorter than 3 symbols. Here, we will skip some important NLP stages such as stemming and lemmatization; however, we will later see that VW solves the problem even without these steps.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">to_vw_format</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">label</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="o">+</span> <span class="s2">&quot; |text &quot;</span>
        <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s2">&quot;\w{3,}&quot;</span><span class="p">,</span> <span class="n">document</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>
        <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="p">)</span>


<span class="n">to_vw_format</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="s2">&quot;rec.autos&quot;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We split the dataset into train and test and write these into separate files. We will consider a document as positive if it corresponds to <strong>rec.autos</strong>. Thus, we are constructing a model which distinguishes articles about cars from other topics:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">all_documents</span> <span class="o">=</span> <span class="n">newsgroups</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
<span class="n">all_targets</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mi">1</span> <span class="k">if</span> <span class="n">newsgroups</span><span class="p">[</span><span class="s2">&quot;target_names&quot;</span><span class="p">][</span><span class="n">target</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;rec.autos&quot;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">newsgroups</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">train_documents</span><span class="p">,</span> <span class="n">test_documents</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">,</span> <span class="n">test_labels</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">all_documents</span><span class="p">,</span> <span class="n">all_targets</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">7</span>
<span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_WRITE_DATA</span><span class="p">,</span> <span class="s2">&quot;20news_train.vw&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">vw_train_data</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">text</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">train_documents</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">):</span>
        <span class="n">vw_train_data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">to_vw_format</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_WRITE_DATA</span><span class="p">,</span> <span class="s2">&quot;20news_test.vw&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">vw_test_data</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">test_documents</span><span class="p">:</span>
        <span class="n">vw_test_data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">to_vw_format</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Now, we pass the created training file to Vowpal Wabbit. We solve the classification problem with a hinge loss function (linear SVM). The trained model will be saved in the <code class="docutils literal notranslate"><span class="pre">20news_model.vw</span></code> file:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!vw -d $PATH_TO_WRITE_DATA/20news_train.vw \</span>
<span class="c1"># --loss_function hinge -f $PATH_TO_WRITE_DATA/20news_model.vw</span>
</pre></div>
</div>
</div>
</div>
<p>VW prints a lot of interesting info while training (one can suppress it with the <code class="docutils literal notranslate"><span class="pre">--quiet</span></code> parameter). You can see documentation of the diagnostic output on <a class="reference external" href="https://github.com/JohnLangford/vowpal_wabbit/wiki/Tutorial#vws-diagnostic-information">GitHub</a>. Note how average loss drops while training. For loss computation, VW uses samples it has never seen before, so this measure is usually accurate. Now, we apply our trained model to the test set, saving predictions into a file with the <code class="docutils literal notranslate"><span class="pre">-p</span></code> flag:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!vw -i $PATH_TO_WRITE_DATA/20news_model.vw -t -d $PATH_TO_WRITE_DATA/20news_test.vw \</span>
<span class="c1"># -p $PATH_TO_WRITE_DATA/20news_test_predictions.txt</span>
</pre></div>
</div>
</div>
</div>
<p>Now we load our predictions, compute AUC, and plot the ROC curve:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_WRITE_DATA</span><span class="p">,</span> <span class="s2">&quot;20news_test_predictions.txt&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">pred_file</span><span class="p">:</span>
    <span class="n">test_prediction</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">pred_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>

<span class="n">auc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">test_labels</span><span class="p">,</span> <span class="n">test_prediction</span><span class="p">)</span>
<span class="n">roc_curve</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">test_labels</span><span class="p">,</span> <span class="n">test_prediction</span><span class="p">)</span>

<span class="k">with</span> <span class="n">plt</span><span class="o">.</span><span class="n">xkcd</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">roc_curve</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">roc_curve</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;FPR&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;TPR&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;test AUC = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">auc</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">]);</span>
</pre></div>
</div>
</div>
</div>
<p>The AUC value we get shows that we have achieved high classification quality.</p>
</div>
<div class="section" id="news-multiclass-classification">
<h3>3.2. News. Multiclass classification<a class="headerlink" href="#news-multiclass-classification" title="Permalink to this headline">¶</a></h3>
<p>We will use the same news dataset, but, this time, we will solve a multiclass classification problem. <code class="docutils literal notranslate"><span class="pre">Vowpal</span> <span class="pre">Wabbit</span></code> is a little picky – it wants labels starting from 1 till K, where K – is the number of classes in the classification task (20 in our case). So we will use LabelEncoder and add 1 afterwards (recall that <code class="docutils literal notranslate"><span class="pre">LabelEncoder</span></code> maps labels into range from 0 to K-1).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">all_documents</span> <span class="o">=</span> <span class="n">newsgroups</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
<span class="n">topic_encoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>
<span class="n">all_targets_mult</span> <span class="o">=</span> <span class="n">topic_encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">newsgroups</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<p><strong>The data is the same, but we have changed the labels, train_labels_mult and test_labels_mult, into label vectors from 1 to 20.</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">train_documents</span><span class="p">,</span> <span class="n">test_documents</span><span class="p">,</span> <span class="n">train_labels_mult</span><span class="p">,</span> <span class="n">test_labels_mult</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">all_documents</span><span class="p">,</span> <span class="n">all_targets_mult</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">7</span>
<span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_WRITE_DATA</span><span class="p">,</span> <span class="s2">&quot;20news_train_mult.vw&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">vw_train_data</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">text</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">train_documents</span><span class="p">,</span> <span class="n">train_labels_mult</span><span class="p">):</span>
        <span class="n">vw_train_data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">to_vw_format</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_WRITE_DATA</span><span class="p">,</span> <span class="s2">&quot;20news_test_mult.vw&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">vw_test_data</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">test_documents</span><span class="p">:</span>
        <span class="n">vw_test_data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">to_vw_format</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>We train Vowpal Wabbit in multiclass classification mode, passing the <code class="docutils literal notranslate"><span class="pre">oaa</span></code> parameter(“one against all”) with the number of classes. Also, let’s see what parameters our model quality is dependent on (more info can be found in the <a class="reference external" href="https://github.com/JohnLangford/vowpal_wabbit/wiki/Tutorial">official Vowpal Wabbit tutorial</a>):</p>
<ul class="simple">
<li><p>learning rate (-l, 0.5 default) – rate of weight change on every step</p></li>
<li><p>learning rate decay (–power_t, 0.5 default) – it is proven in practice, that, if the learning rate drops with the number of steps in stochastic gradient descent, we approach the minimum loss better</p></li>
<li><p>loss function (–loss_function) – the entire training algorithm depends on it. See <a class="reference external" href="https://github.com/JohnLangford/vowpal_wabbit/wiki/Loss-functions">docs</a> for loss functions</p></li>
<li><p>Regularization (-l1) – note that VW  calculates regularization for every object. That is why we usually set regularization values to about <span class="math notranslate nohighlight">\(10^{-20}.\)</span></p></li>
</ul>
<p>Additionally, we can try automatic Vowpal Wabbit parameter tuning with <a class="reference external" href="https://github.com/hyperopt/hyperopt">Hyperopt</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!vw --oaa 20 $PATH_TO_WRITE_DATA/20news_train_mult.vw -f $PATH_TO_WRITE_DATA/ \</span>
<span class="c1">#20news_model_mult.vw --loss_function=hinge</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#%%time</span>
<span class="c1">#!vw -i $PATH_TO_WRITE_DATA/20news_model_mult.vw -t -d $PATH_TO_WRITE_DATA/20news_test_mult.vw \</span>
<span class="c1">#-p $PATH_TO_WRITE_DATA/20news_test_predictions_mult.txt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_WRITE_DATA</span><span class="p">,</span> <span class="s2">&quot;20news_test_predictions_mult.txt&quot;</span><span class="p">)</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">pred_file</span><span class="p">:</span>
    <span class="n">test_prediction_mult</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">pred_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">accuracy_score</span><span class="p">(</span><span class="n">test_labels_mult</span><span class="p">,</span> <span class="n">test_prediction_mult</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here is how often the model misclassifies atheism with other topics:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">M</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">test_labels_mult</span><span class="p">,</span> <span class="n">test_prediction_mult</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">newsgroups</span><span class="p">[</span><span class="s2">&quot;target_names&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="imdb-movie-reviews">
<h3>3.3. IMDB movie reviews<a class="headerlink" href="#imdb-movie-reviews" title="Permalink to this headline">¶</a></h3>
<p>In this part we will do binary classification of <a class="reference external" href="http://www.imdb.com">IMDB</a> (International Movie DataBase) movie reviews. We will see how fast Vowpal Wabbit performs.</p>
<p>Using the <code class="docutils literal notranslate"><span class="pre">load_files</span></code> function from <code class="docutils literal notranslate"><span class="pre">sklearn.datasets</span></code>, we load the movie reviews datasets. It’s the same dataset we used in topic04 part4 notebook.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tarfile</span>
<span class="c1"># Download the dataset if not already in place</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>

<span class="kn">import</span> <span class="nn">requests</span>

<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://ai.stanford.edu/~amaas/data/sentiment/aclImdb_v1.tar.gz&quot;</span>


<span class="k">def</span> <span class="nf">load_imdb_dataset</span><span class="p">(</span><span class="n">extract_path</span><span class="o">=</span><span class="n">PATH_TO_WRITE_DATA</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># check if existed already</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extract_path</span><span class="p">,</span> <span class="s2">&quot;aclImdb&quot;</span><span class="p">,</span> <span class="s2">&quot;README&quot;</span><span class="p">))</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span>
    <span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;IMDB dataset is already in place.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Downloading the dataset from:  &quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;r:gz&quot;</span><span class="p">,</span> <span class="n">fileobj</span><span class="o">=</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">tar</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">extract_path</span><span class="p">)</span>


<span class="n">load_imdb_dataset</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Read train data, separate labels.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PATH_TO_IMDB</span> <span class="o">=</span> <span class="n">PATH_TO_WRITE_DATA</span> <span class="o">+</span> <span class="s2">&quot;aclImdb&quot;</span>

<span class="n">reviews_train</span> <span class="o">=</span> <span class="n">load_files</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_IMDB</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">),</span> <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="s2">&quot;neg&quot;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">text_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">reviews_train</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">reviews_train</span><span class="o">.</span><span class="n">target</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of documents in training data: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">text_train</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">y_train</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Do the same for the test set.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reviews_test</span> <span class="o">=</span> <span class="n">load_files</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_IMDB</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">),</span> <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">,</span> <span class="s2">&quot;neg&quot;</span><span class="p">])</span>
<span class="n">text_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">reviews_test</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">reviews_test</span><span class="o">.</span><span class="n">target</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of documents in test data: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">text_test</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">y_test</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Take a look at examples of reviews and their corresponding labels.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">text_train</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">y_train</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># good review</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">text_train</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">y_train</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># bad review</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">to_vw_format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">text_train</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">y_train</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now, we prepare training (<code class="docutils literal notranslate"><span class="pre">movie_reviews_train.vw</span></code>), validation (<code class="docutils literal notranslate"><span class="pre">movie_reviews_valid.vw</span></code>), and test (<code class="docutils literal notranslate"><span class="pre">movie_reviews_test.vw</span></code>) sets for Vowpal Wabbit. We will use 70% for training, 30% for the hold-out set.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">train_share</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.7</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">text_train</span><span class="p">))</span>
<span class="n">train</span><span class="p">,</span> <span class="n">valid</span> <span class="o">=</span> <span class="n">text_train</span><span class="p">[:</span><span class="n">train_share</span><span class="p">],</span> <span class="n">text_train</span><span class="p">[</span><span class="n">train_share</span><span class="p">:]</span>
<span class="n">train_labels</span><span class="p">,</span> <span class="n">valid_labels</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">[:</span><span class="n">train_share</span><span class="p">],</span> <span class="n">y_train</span><span class="p">[</span><span class="n">train_share</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">train_labels</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_WRITE_DATA</span><span class="p">,</span> <span class="s2">&quot;movie_reviews_train.vw&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">vw_train_data</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">text</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">):</span>
        <span class="n">vw_train_data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">to_vw_format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_WRITE_DATA</span><span class="p">,</span> <span class="s2">&quot;movie_reviews_valid.vw&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">vw_train_data</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">text</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span> <span class="n">valid_labels</span><span class="p">):</span>
        <span class="n">vw_train_data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">to_vw_format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">),</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_WRITE_DATA</span><span class="p">,</span> <span class="s2">&quot;movie_reviews_test.vw&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">vw_test_data</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">text_test</span><span class="p">:</span>
        <span class="n">vw_test_data</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">to_vw_format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!head -2 $PATH_TO_WRITE_DATA/movie_reviews_train.vw
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!head -2 $PATH_TO_WRITE_DATA/movie_reviews_valid.vw
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!head -2 $PATH_TO_WRITE_DATA/movie_reviews_test.vw
</pre></div>
</div>
</div>
</div>
<p><strong>Now we launch Vowpal Wabbit with the following arguments:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-d</span></code>, path to training set (corresponding .vw file)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--loss_function</span></code> – hinge (feel free to experiment here)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-f</span></code> – path to the output file (which can also be in the .vw format)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!vw -d $PATH_TO_WRITE_DATA/movie_reviews_train.vw --loss_function hinge \
-f $PATH_TO_WRITE_DATA/movie_reviews_model.vw --quiet
</pre></div>
</div>
</div>
</div>
<p>Next, make the hold-out prediction with the following VW arguments:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">-i</span></code> –path to the trained model (.vw file)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-d</span></code> – path to the hold-out set (.vw file)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-p</span></code> – path to a txt-file where the predictions will be stored</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-t</span></code> - tells VW to ignore labels</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!vw -i $PATH_TO_WRITE_DATA/movie_reviews_model.vw -t \
-d $PATH_TO_WRITE_DATA/movie_reviews_valid.vw -p $PATH_TO_WRITE_DATA/movie_valid_pred.txt --quiet
</pre></div>
</div>
</div>
</div>
<p>Read the predictions from the text file and estimate the accuracy and ROC AUC. Note that VW prints probability estimates of the +1 class. These estimates are distributed from  -1 to 1, so we can convert these into binary answers, assuming that positive values belong to class 1.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_WRITE_DATA</span><span class="p">,</span> <span class="s2">&quot;movie_valid_pred.txt&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">pred_file</span><span class="p">:</span>
    <span class="n">valid_prediction</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">pred_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;Accuracy: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="nb">round</span><span class="p">(</span>
            <span class="n">accuracy_score</span><span class="p">(</span>
                <span class="n">valid_labels</span><span class="p">,</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">pred_prob</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">pred_prob</span> <span class="ow">in</span> <span class="n">valid_prediction</span><span class="p">]</span>
            <span class="p">),</span>
            <span class="mi">3</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AUC: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">valid_labels</span><span class="p">,</span> <span class="n">valid_prediction</span><span class="p">),</span> <span class="mi">3</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<p>Again, do the same for the test set.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!vw -i $PATH_TO_WRITE_DATA/movie_reviews_model.vw -t \
-d $PATH_TO_WRITE_DATA/movie_reviews_test.vw \
-p $PATH_TO_WRITE_DATA/movie_test_pred.txt --quiet
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_WRITE_DATA</span><span class="p">,</span> <span class="s2">&quot;movie_test_pred.txt&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">pred_file</span><span class="p">:</span>
    <span class="n">test_prediction</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">pred_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;Accuracy: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="nb">round</span><span class="p">(</span>
            <span class="n">accuracy_score</span><span class="p">(</span>
                <span class="n">y_test</span><span class="p">,</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">pred_prob</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">pred_prob</span> <span class="ow">in</span> <span class="n">test_prediction</span><span class="p">]</span>
            <span class="p">),</span>
            <span class="mi">3</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AUC: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">test_prediction</span><span class="p">),</span> <span class="mi">3</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s try to achieve a higher accuracy by incorporating bigrams.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!vw -d $PATH_TO_WRITE_DATA/movie_reviews_train.vw \
--loss_function hinge --ngram 2 -f $PATH_TO_WRITE_DATA/movie_reviews_model2.vw --quiet
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!vw -i$PATH_TO_WRITE_DATA/movie_reviews_model2.vw -t -d $PATH_TO_WRITE_DATA/movie_reviews_valid.vw \
-p $PATH_TO_WRITE_DATA/movie_valid_pred2.txt --quiet
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_WRITE_DATA</span><span class="p">,</span> <span class="s2">&quot;movie_valid_pred2.txt&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">pred_file</span><span class="p">:</span>
    <span class="n">valid_prediction</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">pred_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;Accuracy: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="nb">round</span><span class="p">(</span>
            <span class="n">accuracy_score</span><span class="p">(</span>
                <span class="n">valid_labels</span><span class="p">,</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">pred_prob</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">pred_prob</span> <span class="ow">in</span> <span class="n">valid_prediction</span><span class="p">]</span>
            <span class="p">),</span>
            <span class="mi">3</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AUC: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">valid_labels</span><span class="p">,</span> <span class="n">valid_prediction</span><span class="p">),</span> <span class="mi">3</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>!vw -i $PATH_TO_WRITE_DATA/movie_reviews_model2.vw -t -d $PATH_TO_WRITE_DATA/movie_reviews_test.vw \
-p $PATH_TO_WRITE_DATA/movie_test_pred2.txt --quiet
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PATH_TO_WRITE_DATA</span><span class="p">,</span> <span class="s2">&quot;movie_test_pred2.txt&quot;</span><span class="p">))</span> <span class="k">as</span> <span class="n">pred_file</span><span class="p">:</span>
    <span class="n">test_prediction2</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">pred_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()]</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;Accuracy: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="nb">round</span><span class="p">(</span>
            <span class="n">accuracy_score</span><span class="p">(</span>
                <span class="n">y_test</span><span class="p">,</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">pred_prob</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">pred_prob</span> <span class="ow">in</span> <span class="n">test_prediction2</span><span class="p">]</span>
            <span class="p">),</span>
            <span class="mi">3</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AUC: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">test_prediction2</span><span class="p">),</span> <span class="mi">3</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<p>Adding bigrams really helped to improve our model!</p>
</div>
<div class="section" id="classifying-gigabytes-of-stackoverflow-questions">
<h3>3.4. Classifying gigabytes of StackOverflow questions<a class="headerlink" href="#classifying-gigabytes-of-stackoverflow-questions" title="Permalink to this headline">¶</a></h3>
<p>This section has been moved to Kaggle, please explore <a class="reference external" href="https://www.kaggle.com/kashnitsky/topic-8-online-learning-and-vowpal-wabbit">this Notebook</a>.</p>
</div>
</div>
<div class="section" id="useful-resources">
<h2>4. Useful resources<a class="headerlink" href="#useful-resources" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>The same notebook as am interactive web-based <a class="reference external" href="https://www.kaggle.com/kashnitsky/topic-8-online-learning-and-vowpal-wabbit">Kaggle Kernel</a></p></li>
<li><p><a class="reference external" href="https://www.kaggle.com/kashnitsky/training-while-reading-vowpal-wabbit-starter">“Training while reading”</a> - an example of the Python wrapper usage</p></li>
<li><p>Main course <a class="reference external" href="https://mlcourse.ai">site</a>, <a class="reference external" href="https://github.com/Yorko/mlcourse.ai">course repo</a>, and YouTube <a class="reference external" href="https://www.youtube.com/watch?v=QKTuw4PNOsU&amp;list=PLVlY_7IJCMJeRfZ68eVfEcu-UcN9BbwiX">channel</a></p></li>
<li><p>Course materials as a <a class="reference external" href="https://www.kaggle.com/kashnitsky/mlcourse">Kaggle Dataset</a></p></li>
<li><p>Official VW <a class="reference external" href="https://github.com/JohnLangford/vowpal_wabbit/wiki">documentation</a> on Github</p></li>
<li><p><a class="reference external" href="https://github.com/VowpalWabbit/vowpal_wabbit/wiki/Awesome-Vowpal-Wabbit">“Awesome Vowpal Wabbit”</a> Wiki</p></li>
<li><p><a class="reference external" href="https://booking.ai/dont-be-tricked-by-the-hashing-trick-192a6aae3087">Don’t be tricked by the Hashing Trick</a> - analysis of hash collisions, their dependency on feature space and hashing space dimensions and affecting classification/regression performance</p></li>
<li><p><a class="reference external" href="http://www.deeplearningbook.org/contents/numerical.html">“Numeric Computation” Chapter</a> of the <a class="reference external" href="http://www.deeplearningbook.org/">Deep Learning book</a></p></li>
<li><p><a class="reference external" href="https://www.amazon.com/Convex-Optimization-Stephen-Boyd/dp/0521833787">“Convex Optimization” by Stephen Boyd</a></p></li>
<li><p>“Command-line Tools can be 235x Faster than your Hadoop Cluster” <a class="reference external" href="https://aadrake.com/command-line-tools-can-be-235x-faster-than-your-hadoop-cluster.html">post</a></p></li>
<li><p>Benchmarking various ML algorithms on Criteo 1TB dataset on <a class="reference external" href="https://github.com/rambler-digital-solutions/criteo-1tb-benchmark">GitHub</a></p></li>
<li><p><a class="reference external" href="http://fastml.com/blog/categories/vw/">VW on FastML.com</a></p></li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./book/topic08"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="topic08_intro.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Topic 8. Vowpal Wabbit: Learning with Gigabytes of Data</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="videolecture08.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Videolecture 8. Vowpal Wabbit: Learning with Gigabytes of Data</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Yury Kashnitsky (yorko)<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>